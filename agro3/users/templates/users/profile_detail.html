{% extends 'base.html' %}
{% load static %}
{% load user_tags %}
{% load i18n %}

{% block title %}{% trans "Profile" %} - {{ profile_user.get_full_name|default:profile_user.username }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row">
  <div class="col-lg-4">
    <div class="card shadow-sm mb-4">
      <div class="card-body text-center">
        {% if user_profile.avatar %}
          <img src="{{ user_profile.avatar.url }}" class="rounded-circle mb-3" style="width:120px;height:120px;object-fit:cover;" alt="Avatar">
        {% else %}
          <div class="user-avatar-profile mb-3 d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; font-size: 4rem; color: #6c757d; border: 2px solid #dee2e6; border-radius: 50%; background-color: #f8f9fa;">
            {{ profile_user|user_avatar }}
          </div>
        {% endif %}
        <h4 class="mb-0">
          {{ profile_user.get_full_name|default:profile_user.username }}
          {% if user_profile.is_verified_farmer %}
            <i class="bi bi-patch-check-fill text-success ms-1" title="{% trans 'Verified Farmer' %}"></i>
          {% endif %}
        </h4>
        <small class="text-muted">{% trans "Joined" %} {{ profile_user.date_joined|date:"M Y" }}</small>
        
        <!-- Social Stats -->
        <div class="mt-3 mb-3">
          <div class="row text-center">
            <div class="col-4">
              <div class="border-end">
                <div class="h5 mb-0 text-primary">{{ followers_count }}</div>
                <small class="text-muted">{% trans "Followers" %}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="border-end">
                <div class="h5 mb-0 text-success">{{ following_count }}</div>
                <small class="text-muted">{% trans "Following" %}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="h5 mb-0 text-warning">{{ user_posts.count }}</div>
              <small class="text-muted">{% trans "Posts" %}</small>
            </div>
          </div>
        </div>
        
        <div class="mt-3">
          <span class="badge bg-success">{{ user_profile.get_experience_level }}</span>
          <span class="badge bg-info">{{ user_profile.get_farmer_type_display }}</span>
        </div>
        
        <!-- Follow Button -->
        {% if request.user.is_authenticated and request.user != profile_user %}
          <div class="mt-3 d-grid">
            <button id="follow-btn-{{ profile_user.pk }}" 
                    class="btn {% if is_following %}btn-success{% else %}btn-outline-primary{% endif %} follow-btn"
                    data-user-id="{{ profile_user.pk }}"
                    data-is-following="{% if is_following %}true{% else %}false{% endif %}">
              <i class="bi bi-{% if is_following %}check-circle-fill{% else %}person-plus{% endif %}"></i>
              {% if is_following %}{% trans "Following" %}{% else %}{% trans "Follow" %}{% endif %}
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header"><strong>{% trans "About" %}</strong></div>
      <div class="card-body">
        <p class="mb-1"><strong>{% trans "Region" %}:</strong> {{ user_profile.get_region_display }}</p>
        <p class="mb-1"><strong>{% trans "Farmer Type" %}:</strong> {{ user_profile.get_farmer_type_display }}</p>
        <p class="mb-1"><strong>{% trans "Experience" %}:</strong> {{ user_profile.get_experience_level }}</p>
        
        <!-- Contact Information -->
        <div class="contact-info mt-3 p-3 bg-light rounded">
          <h6 class="mb-2"><i class="bi bi-telephone"></i> {% trans "Contact Information" %}</h6>
          <div class="row">
            <div class="col-md-6">
              <strong>{% trans "Email" %}:</strong><br>
              <a href="mailto:{{ profile_user.email }}" class="text-decoration-none">
                <i class="bi bi-envelope"></i> {{ profile_user.email }}
              </a>
            </div>
            {% if user_profile.phone_number %}
            <div class="col-md-6">
              <strong>{% trans "Phone" %}:</strong><br>
              <a href="tel:{{ user_profile.phone_number }}" class="text-decoration-none">
                <i class="bi bi-telephone"></i> {{ user_profile.phone_number }}
              </a>
            </div>
            {% endif %}
          </div>
          {% if user_profile.whatsapp_number %}
          <div class="row mt-2">
            <div class="col-md-6">
              <strong>{% trans "WhatsApp" %}:</strong><br>
              <a href="https://wa.me/{{ user_profile.whatsapp_number|cut:'+' }}" target="_blank" class="text-success text-decoration-none">
                <i class="bi bi-whatsapp"></i> {{ user_profile.whatsapp_number }}
              </a>
            </div>
          </div>
          {% endif %}
        </div>
        
        <p class="mt-3">{% if user_profile.bio %}{{ user_profile.bio }}{% else %}{% trans "No bio provided" %}{% endif %}</p>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header"><strong>{% trans "Recent Posts" %}</strong></div>
      <div class="card-body">
        {% if user_posts %}
          <ul class="list-group list-group-flush">
            {% for post in user_posts %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{{ post.get_absolute_url }}" class="text-decoration-none">{{ post.title }}</a>
                <small class="text-muted">{{ post.publication_date|date:"M d, Y" }}</small>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">{% trans "No posts yet." %}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle follow button clicks with AJAX
    document.querySelectorAll('.follow-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const userId = this.dataset.userId;
            const isFollowing = this.dataset.isFollowing === 'true';
            
            // Disable button during request
            this.disabled = true;
            const originalHtml = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Processing..." %}';
            
            // Make AJAX request
            fetch(`/users/follow/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button state
                    const newIsFollowing = data.is_following;
                    this.dataset.isFollowing = newIsFollowing;
                    
                    // Update button appearance
                    if (newIsFollowing) {
                        this.className = 'btn btn-success follow-btn';
                        this.innerHTML = '<i class="bi bi-check-circle-fill"></i> {% trans "Following" %}';
                    } else {
                        this.className = 'btn btn-outline-primary follow-btn';
                        this.innerHTML = '<i class="bi bi-person-plus"></i> {% trans "Follow" %}';
                    }
                    
                    // Update follower count in stats
                    const followerCountElement = document.querySelector('.h5.text-primary');
                    if (followerCountElement) {
                        followerCountElement.textContent = data.follower_count;
                    }
                    
                    // Show success message
                    showMessage(data.message, 'success');
                } else {
                    // Show error message
                    showMessage(data.error || '{% trans "An error occurred" %}', 'error');
                    this.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('{% trans "Network error occurred" %}', 'error');
                this.innerHTML = originalHtml;
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Helper function to show messages
    function showMessage(message, type) {
        // Create message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        messageDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        messageDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(messageDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}